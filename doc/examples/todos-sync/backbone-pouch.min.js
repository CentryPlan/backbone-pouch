/*! backbone-pouch - v1.2.0 - 2013-10-17
* http://jo.github.io/backbone-pouch/
* Copyright (c) 2013 Johannes J. Schmidt; Licensed MIT */
(function(t){"use strict";function e(t,e){t.options=t.options||{},e.options=e.options||{},t.fetch===void 0&&(t.fetch=e.fetch),t.listen===void 0&&(t.listen=e.listen),t.db===void 0&&(t.db=e.db),o.each(e.options,function(e,n){t.options[n]=n in t.options?t.options[n]:{},o.extend(t.options[n],e)})}var n;n="object"==typeof exports?exports:t.BackbonePouch={};var o=t._;o||"function"!=typeof require||(o=require("underscore"));var i={create:"post",update:"put",patch:"put","delete":"remove"};n.defaults={fetch:"allDocs",listen:!1,options:{post:{},put:{},get:{},remove:{},allDocs:{},query:{},spatial:{},changes:{continuous:!0}}},n.sync=function(t){t=t||{},e(t,n.defaults);var r=function(n,r,c){function s(t,e){return t?c.error&&c.error(t):(("create"===n||"update"===n||"patch"===n)&&(e={_id:e.id,_rev:e.rev}),"delete"===n&&(e={}),"read"===n&&(e.rows&&(e=o.map(e.rows,function(t){return t.doc||o.extend({_id:t.id},t.value)})),c.listen&&c.db.info(function(t,e){c.db.changes(o.extend({},c.options.changes,{since:e.update_seq,onChange:function(t){var e=r.get(t.id);t.deleted?e&&e.destroy():e?e.set(t.doc):r.add(t.doc),"function"==typeof c.options.changes.onChange&&c.options.changes.onChange(t)}}))})),c.success&&c.success(e))}if(c=c||{},e(c,r&&r.pouch||{}),e(c,t),"string"!=typeof n)return c;if(!c.db)throw Error('A "db" property must be specified');if(r.trigger("request",r,c.db,c),"read"===n){if(r.id)return c.db.get(r.id,c.options.get,s);if("query"===c.fetch||"spatial"===c.fetch){if(!c.options[c.fetch].fun)throw Error('A "'+c.fetch+'.fun" object must be specified');return c.db[c.fetch](c.options[c.fetch].fun,c.options[c.fetch],s)}c.db[c.fetch](c.options[c.fetch],s)}else c.db[i[n]](r.toJSON(),c.options[i[n]],s);return c};return r.defaults=t,r},n.attachments=function(t){function e(e){if(e.pouch&&e.pouch.db)return e.pouch.db;if(e.collection&&e.collection.pouch&&e.collection.pouch.db)return e.collection.pouch.db;if(t.db)return t.db;var n=e.sync();if(n.db)return n.db;throw Error('A "db" property must be specified')}return t=t||{},{attachments:function(t){var e=this.get("_attachments")||{};return t?o.filter(o.keys(e),function(n){return"function"==typeof t?t(n,e[n]):e[n].content_type.match(t)}):o.keys(e)},attachment:function(t,n){var o=e(this);return o.getAttachment(this.id,t,n)},attach:function(t,n,o,i){"function"==typeof n&&(i=n,n=void 0,o=void 0),"function"==typeof o&&(i=o,o=void 0),n=n||t.filename,o=o||t.type,this.id||this.set({_id:Math.uuid()},{silent:!0});var r=e(this),c=this;return r.putAttachment(this.id,n,this.get("_rev"),t,o,function(t,e){if(!t&&e.rev){var r=c.get("_attachments")||{};r[n]={content_type:o,stub:!0},c.set({_rev:e.rev,_attachments:r},{silent:!0})}i(t,e)})}}}})(this);