/*! backbone-pouch - v1.4.0 - 2014-07-07
* http://jo.github.io/backbone-pouch/
* Copyright (c) 2014 Johannes J. Schmidt; Licensed MIT */
!function(a){"use strict";function b(){for(var a={},c=0;c<arguments.length;c++){var d=arguments[c];if("object"==typeof d)for(var e in d)a[e]=d[e]&&a[e]&&"object"==typeof d[e]&&"object"==typeof a[e]&&"db"!==e?b(a[e]||{},d[e]):d[e]}return a}var c;c="object"==typeof exports?exports:a.BackbonePouch={};var d=a._;d||"function"!=typeof require||(d=require("underscore"));var e={create:"post",update:"put",patch:"put","delete":"remove"};c.defaults={fetch:"allDocs",listen:!1,options:{post:{},put:{},get:{},remove:{},allDocs:{},query:{},spatial:{},changes:{continuous:!0}}},c.sync=function(a){a=a||{},a=b(c.defaults,a);var f=function(c,f,g){function h(a,b){return a?g.error&&g.error(a):(("create"===c||"update"===c||"patch"===c)&&(b={_id:b.id,_rev:b.rev}),"delete"===c&&(b={}),"read"===c&&g.listen&&g.db.info(function(a,b){g.db.changes(d.extend({},g.options.changes,{since:b.update_seq,onChange:function(a){var b=f.get(a.id);a.deleted?b&&b.destroy():b?b.set(a.doc):f.add(a.doc),"function"==typeof g.options.changes.onChange&&g.options.changes.onChange(a)}}))}),g.success&&g.success(b))}if(g=g||{},g=b(a,f&&f.pouch||{},g),"string"!=typeof c)return g;if(!g.db)throw new Error('A "db" property must be specified');if(f.trigger("request",f,g.db,g),"read"===c){if(f.id)return g.db.get(f.id,g.options.get,h);if("query"===g.fetch||"spatial"===g.fetch){if(!g.options[g.fetch].fun)throw new Error('A "'+g.fetch+'.fun" object must be specified');return g.db[g.fetch](g.options[g.fetch].fun,g.options[g.fetch],h)}g.db[g.fetch](g.options[g.fetch],h)}else g.db[e[c]](f.toJSON(),g.options[e[c]],h);return g};return f.defaults=a,f},c.attachments=function(a){function b(b){if(b.pouch&&b.pouch.db)return b.pouch.db;if(b.collection&&b.collection.pouch&&b.collection.pouch.db)return b.collection.pouch.db;if(a.db)return a.db;var c=b.sync();if(c.db)return c.db;throw new Error('A "db" property must be specified')}return a=a||{},{attachments:function(a){var b=this.get("_attachments")||{};return a?d.filter(d.keys(b),function(c){return"function"==typeof a?a(c,b[c]):b[c].content_type.match(a)}):d.keys(b)},attachment:function(a,c){var d=b(this);return d.getAttachment(this.id,a,c)},attach:function(a,c,d,e){"function"==typeof c&&(e=c,c=void 0,d=void 0),"function"==typeof d&&(e=d,d=void 0),c=c||a.filename,d=d||a.type;var f=b(this),g=this;return f.putAttachment(this.id,c,this.get("_rev"),a,d,function(a,b){if(!a&&b.rev){var f=g.get("_attachments")||{};f[c]={content_type:d,stub:!0},g.set({_id:b.id,_rev:b.rev,_attachments:f},{silent:!0})}e(a,b)})}}}}(this);